@startuml
title BlackPoker 誘発アクション処理(概要)

'==============================
'【Main method】（アクション分類・プレイヤー毎処理）
'==============================
|Main method|
start
:[6-1] 各プレイヤーの誘発アクションを「即時/通常 × メイン/クイック」に分類し、
アクションバッファに追加;

while (アクションバッファは空か？) is (Yes)

    '【6-2】 アクションバッファの状態をチェック
    while ([6-2] アクションバッファに即時効果はあるか？) is (Yes)
    '------------------------------
    '【即時効果：プレイヤー毎に処理】
    '------------------------------
    group 即時効果: プレイヤー毎に処理
        '【6-3】 各プレイヤーについて「即時効果アクションの有無」を判定
        while (該当プレイヤーに即時効果があるか？) is (Yes)
        :[6-4] タイミング=メインの即時アクションを処理\n⇢ xx参照(メインタイミング);
        :[6-5] タイミング=クイックの即時アクションを処理\n⇢ xx参照(クイックタイミング);
        :次の人へ;
        endwhile
    end group

    end while

    while ([6-2] アクションバッファに通常効果はあるか？) is (Yes)
    '------------------------------
    '【通常効果：プレイヤー毎に処理】
    '------------------------------
    group 通常効果: プレイヤー毎に処理
        '【6-6】 各プレイヤーについて「通常効果アクションの有無」を判定
        while (該当プレイヤーに通常効果があるか？) is (Yes)
        :[6-7] タイミング=メインの通常アクションを処理\n⇢ xx参照(メインタイミング);
        :[6-8] タイミング=クイックの通常アクションを処理\n⇢ xx参照(クイックタイミング);
        :次の人へ;
        endwhile
    end group
    endwhile

endwhile
stop

'==============================
'【即時効果：アクション毎に処理】
'==============================
|即時効果: アクション毎に処理|
start
'【6-9】 アクションバッファから「該当プレイヤー・タイミング」の即時効果アクションが取り出せるか判定
while (アクションバッファから該当プレイヤーとタイミングの\n即時効果アクションを1件取り出せるか？ is Yes)
  :[6-10] アクションバッファから即時効果アクションを取り出す;
  :[6-11] 取り出した即時効果アクションの効果を解決する;
  '【6-12】 勝敗判定をチェック
  if ("[6-12] 勝敗判定") then (決着)
    :[6-13] 勝敗判定を行い、決着がついた場合処理終了;
    stop
  endif
  '【6-14】 取り出したアクションが新たな誘発を発生させたか判定
  if ("[6-14] アクションが新たな誘発を発生させたか？") then (Yes)
    :[6-15] 誘発したアクションをアクションバッファに追加;
  endif
endwhile
stop

'==============================
'【通常効果：アクション毎に処理】
'==============================
|通常効果: アクション毎に処理|
start
'【6-16】 アクションバッファから「該当プレイヤー・タイミング」の通常効果アクションが取り出せるか判定
while (アクションバッファから該当プレイヤーとタイミングの\n通常効果アクションを1件取り出せるか？ is Yes)
  :[6-17] アクションバッファから通常効果アクションを取り出す;
  '【6-18】 取り出した通常効果のタイミングがメインかどうか判定
  if ("[6-18] 取り出した通常効果のタイミングがメインか判定") then (Yes)
    :[6-19] タイミングがメインの場合、ステージの空きを判定;
    '【6-20】 ステージが空いているかチェック
    if ("[6-20] ステージが空か？") then (Yes)
      :[6-21] ステージが空の場合、通常効果アクションをステージに追加;
    else (No)
      :[6-22] ステージが埋まっている場合、通常効果アクションを破棄;
    endif
  else (No)
    :[6-23] タイミングがクイックの場合、通常効果アクションをステージに追加;
  endif
  '【6-24】 取り出したアクションが誘発を発生させたか判定
  if ("[6-24] アクションが誘発を発生させたか？") then (Yes)
    :[6-25] 誘発したアクションをアクションバッファに追加;
  endif
endwhile
stop

@enduml
